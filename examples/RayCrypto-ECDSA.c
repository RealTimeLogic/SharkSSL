/**
 *     ____             _________                __                _
 *    / __ \___  ____ _/ /_  __(_)___ ___  ___  / /   ____  ____ _(_)____
 *   / /_/ / _ \/ __ `/ / / / / / __ `__ \/ _ \/ /   / __ \/ __ `/ / ___/
 *  / _, _/  __/ /_/ / / / / / / / / / / /  __/ /___/ /_/ / /_/ / / /__
 * /_/ |_|\___/\__,_/_/ /_/ /_/_/ /_/ /_/\___/_____/\____/\__, /_/\___/
 *                                                       /____/
 *
 *                 SharkSSL Embedded SSL/TLS Stack
 ****************************************************************************
 *   PROGRAM MODULE
 *
 *   $Id: RayCrypto-ECDSA.c 5481 2023-10-08 21:31:49Z wini $
 *
*   COPYRIGHT:  Real Time Logic LLC, 2015 - 2023
 *
 *   This software is copyrighted by and is the sole property of Real
 *   Time Logic LLC.  All rights, title, ownership, or other interests in
 *   the software remain the property of Real Time Logic LLC.  This
 *   software may only be used in accordance with the terms and
 *   conditions stipulated in the corresponding license agreement under
 *   which the software has been supplied.  Any unauthorized use,
 *   duplication, transmission, distribution, or disclosure of this
 *   software is expressly forbidden.
 *
 *   This Copyright notice may not be removed or modified without prior
 *   written consent of Real Time Logic LLC.
 *
 *   Real Time Logic LLC. reserves the right to modify this software
 *   without notice.
 *
 *               http://www.realtimelogic.com
 *               http://www.sharkssl.com
 ****************************************************************************
 *
 */
#define _SHARKSSL_C_         /* standalone RayCrypto ECDSA library */
#include "selib.h"
#include "SharkSslCrypto.h"  /* SharkSSL.h included by SharkSslCrypto.h */

/*
  The private key can be extracted directly from an X.509 ECC private key.
  The section 
  -----BEGIN EC PARAMETERS-----
  ...
  -----END EC PARAMETERS-----
  can be omitted.

  The public key must first be generated as follows before it can be converted by SharkSSLParseKey
   openssl ec -in my-private.key -pubout > my.pub
*/

#if SHARKSSL_ENABLE_PEM_API
#if SHARKSSL_ECC_USE_SECP256R1
#if (!SHARKSSL_ECDSA_ONLY_VERIFY)
const char *sharkSslPrivECKey256PEM = "-----BEGIN EC PRIVATE KEY-----\n"
                                      "MHcCAQEEIPaciD2cMkHeJTTZI91xDvI3g67G1b/qYcmB5Q+Eg/o/oAoGCCqGSM49\n"
                                      "AwEHoUQDQgAEESPo6gUUKOA3rPMONVhYqBYLYuvuyQYvKs+DH5M834QEv06AXagN\n"
                                      "FdcCrY7Q+uK1aYySAPW2qBwNf55cJ5NcVw==\n"
                                      "-----END EC PRIVATE KEY-----";
#endif

const char *sharkSslPubECKey256PEM  = "-----BEGIN PUBLIC KEY-----\n"
                                      "MFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEESPo6gUUKOA3rPMONVhYqBYLYuvu\n"
                                      "yQYvKs+DH5M834QEv06AXagNFdcCrY7Q+uK1aYySAPW2qBwNf55cJ5NcVw==\n"
                                      "-----END PUBLIC KEY-----\n";
#endif

#if SHARKSSL_ECC_USE_SECP521R1
#if (!SHARKSSL_ECDSA_ONLY_VERIFY)
const char *sharkSslPrivECKey521PEM = "-----BEGIN EC PRIVATE KEY-----\n"
                                      "MIHcAgEBBEIBQ1h2pS1haXbRvNueUu/4EO79MGNRLPtXI7VUhgzZ1lCqIIIu2Aji\n"
                                      "8ffXoh4F+tGuB3LKFLXATHE5Xa0M3yV8WCSgBwYFK4EEACOhgYkDgYYABAGLbFSf\n"
                                      "6yJ7klt7GKzElV3zN/7Nxy8KrEmsNKwuA1sCuvS+Kp8y800wv1F79PABQajY2GoN\n"
                                      "MeYowstBaKD6pc0htQE3aDEbIRBD/liVorOPoyYlIGJKEjBL5HM9phMY13ABuk2I\n"
                                      "JqaCo3MmmLl8Nv3Cz6xxdD8YuJrCXubf/C2g0Du7dQ==\n"
                                      "-----END EC PRIVATE KEY-----";
#endif

const char *sharkSslPubECKey521PEM  = "-----BEGIN PUBLIC KEY-----\n"
                                      "MIGbMBAGByqGSM49AgEGBSuBBAAjA4GGAAQBi2xUn+sie5JbexisxJVd8zf+zccv\n"
                                      "CqxJrDSsLgNbArr0viqfMvNNML9Re/TwAUGo2NhqDTHmKMLLQWig+qXNIbUBN2gx\n"
                                      "GyEQQ/5YlaKzj6MmJSBiShIwS+RzPaYTGNdwAbpNiCamgqNzJpi5fDb9ws+scXQ/\n"
                                      "GLiawl7m3/wtoNA7u3U=\n"
                                      "-----END PUBLIC KEY-----\n";
#endif
#else


/*
  The private and public key data below have been extracted by running the command line tool SharkSSLParseKey
  on the above PEM keys.
*/

#if SHARKSSL_ECC_USE_SECP256R1
#if (!SHARKSSL_ECDSA_ONLY_VERIFY)
const U8 sharkSslPrivECKey256[104] =
{
   0x30, 0x82, 0x00, 0x00, 0x02, 0x20, 0x17, 0x20,
   0xF6, 0x9C, 0x88, 0x3D, 0x9C, 0x32, 0x41, 0xDE,
   0x25, 0x34, 0xD9, 0x23, 0xDD, 0x71, 0x0E, 0xF2,
   0x37, 0x83, 0xAE, 0xC6, 0xD5, 0xBF, 0xEA, 0x61,
   0xC9, 0x81, 0xE5, 0x0F, 0x84, 0x83, 0xFA, 0x3F,
   0x11, 0x23, 0xE8, 0xEA, 0x05, 0x14, 0x28, 0xE0,
   0x37, 0xAC, 0xF3, 0x0E, 0x35, 0x58, 0x58, 0xA8,
   0x16, 0x0B, 0x62, 0xEB, 0xEE, 0xC9, 0x06, 0x2F,
   0x2A, 0xCF, 0x83, 0x1F, 0x93, 0x3C, 0xDF, 0x84,
   0x04, 0xBF, 0x4E, 0x80, 0x5D, 0xA8, 0x0D, 0x15,
   0xD7, 0x02, 0xAD, 0x8E, 0xD0, 0xFA, 0xE2, 0xB5,
   0x69, 0x8C, 0x92, 0x00, 0xF5, 0xB6, 0xA8, 0x1C,
   0x0D, 0x7F, 0x9E, 0x5C, 0x27, 0x93, 0x5C, 0x57
};
#endif

const U8 sharkSslPubECKey256[72] =
{
   0x30, 0x82, 0x00, 0x00, 0x0A, 0x00, 0x17, 0x20, 
   0x11, 0x23, 0xE8, 0xEA, 0x05, 0x14, 0x28, 0xE0,
   0x37, 0xAC, 0xF3, 0x0E, 0x35, 0x58, 0x58, 0xA8,
   0x16, 0x0B, 0x62, 0xEB, 0xEE, 0xC9, 0x06, 0x2F,
   0x2A, 0xCF, 0x83, 0x1F, 0x93, 0x3C, 0xDF, 0x84,
   0x04, 0xBF, 0x4E, 0x80, 0x5D, 0xA8, 0x0D, 0x15,
   0xD7, 0x02, 0xAD, 0x8E, 0xD0, 0xFA, 0xE2, 0xB5,
   0x69, 0x8C, 0x92, 0x00, 0xF5, 0xB6, 0xA8, 0x1C,
   0x0D, 0x7F, 0x9E, 0x5C, 0x27, 0x93, 0x5C, 0x57
};
#endif

#if SHARKSSL_ECC_USE_SECP521R1
#if (!SHARKSSL_ECDSA_ONLY_VERIFY)
const U8 sharkSslPrivECKey521[208] =
{
   0x30, 0x82, 0x00, 0x00, 0x02, 0x42, 0x19, 0x42,
   0x01, 0x43, 0x58, 0x76, 0xA5, 0x2D, 0x61, 0x69,
   0x76, 0xD1, 0xBC, 0xDB, 0x9E, 0x52, 0xEF, 0xF8,
   0x10, 0xEE, 0xFD, 0x30, 0x63, 0x51, 0x2C, 0xFB,
   0x57, 0x23, 0xB5, 0x54, 0x86, 0x0C, 0xD9, 0xD6,
   0x50, 0xAA, 0x20, 0x82, 0x2E, 0xD8, 0x08, 0xE2,
   0xF1, 0xF7, 0xD7, 0xA2, 0x1E, 0x05, 0xFA, 0xD1,
   0xAE, 0x07, 0x72, 0xCA, 0x14, 0xB5, 0xC0, 0x4C,
   0x71, 0x39, 0x5D, 0xAD, 0x0C, 0xDF, 0x25, 0x7C,
   0x58, 0x24, 0x01, 0x8B, 0x6C, 0x54, 0x9F, 0xEB,
   0x22, 0x7B, 0x92, 0x5B, 0x7B, 0x18, 0xAC, 0xC4,
   0x95, 0x5D, 0xF3, 0x37, 0xFE, 0xCD, 0xC7, 0x2F,
   0x0A, 0xAC, 0x49, 0xAC, 0x34, 0xAC, 0x2E, 0x03,
   0x5B, 0x02, 0xBA, 0xF4, 0xBE, 0x2A, 0x9F, 0x32,
   0xF3, 0x4D, 0x30, 0xBF, 0x51, 0x7B, 0xF4, 0xF0,
   0x01, 0x41, 0xA8, 0xD8, 0xD8, 0x6A, 0x0D, 0x31,
   0xE6, 0x28, 0xC2, 0xCB, 0x41, 0x68, 0xA0, 0xFA,
   0xA5, 0xCD, 0x21, 0xB5, 0x01, 0x37, 0x68, 0x31,
   0x1B, 0x21, 0x10, 0x43, 0xFE, 0x58, 0x95, 0xA2,
   0xB3, 0x8F, 0xA3, 0x26, 0x25, 0x20, 0x62, 0x4A,
   0x12, 0x30, 0x4B, 0xE4, 0x73, 0x3D, 0xA6, 0x13,
   0x18, 0xD7, 0x70, 0x01, 0xBA, 0x4D, 0x88, 0x26,
   0xA6, 0x82, 0xA3, 0x73, 0x26, 0x98, 0xB9, 0x7C,
   0x36, 0xFD, 0xC2, 0xCF, 0xAC, 0x71, 0x74, 0x3F,
   0x18, 0xB8, 0x9A, 0xC2, 0x5E, 0xE6, 0xDF, 0xFC,
   0x2D, 0xA0, 0xD0, 0x3B, 0xBB, 0x75, 0xFF, 0xFF
};
#endif

const U8 sharkSslPubECKey521[144] =
{
   0x30, 0x82, 0x00, 0x00, 0x0A, 0x00, 0x19, 0x42,
   0x01, 0x8B, 0x6C, 0x54, 0x9F, 0xEB, 0x22, 0x7B,
   0x92, 0x5B, 0x7B, 0x18, 0xAC, 0xC4, 0x95, 0x5D,
   0xF3, 0x37, 0xFE, 0xCD, 0xC7, 0x2F, 0x0A, 0xAC,
   0x49, 0xAC, 0x34, 0xAC, 0x2E, 0x03, 0x5B, 0x02,
   0xBA, 0xF4, 0xBE, 0x2A, 0x9F, 0x32, 0xF3, 0x4D,
   0x30, 0xBF, 0x51, 0x7B, 0xF4, 0xF0, 0x01, 0x41,
   0xA8, 0xD8, 0xD8, 0x6A, 0x0D, 0x31, 0xE6, 0x28,
   0xC2, 0xCB, 0x41, 0x68, 0xA0, 0xFA, 0xA5, 0xCD,
   0x21, 0xB5, 0x01, 0x37, 0x68, 0x31, 0x1B, 0x21,
   0x10, 0x43, 0xFE, 0x58, 0x95, 0xA2, 0xB3, 0x8F,
   0xA3, 0x26, 0x25, 0x20, 0x62, 0x4A, 0x12, 0x30,
   0x4B, 0xE4, 0x73, 0x3D, 0xA6, 0x13, 0x18, 0xD7,
   0x70, 0x01, 0xBA, 0x4D, 0x88, 0x26, 0xA6, 0x82,
   0xA3, 0x73, 0x26, 0x98, 0xB9, 0x7C, 0x36, 0xFD,
   0xC2, 0xCF, 0xAC, 0x71, 0x74, 0x3F, 0x18, 0xB8,
   0x9A, 0xC2, 0x5E, 0xE6, 0xDF, 0xFC, 0x2D, 0xA0,
   0xD0, 0x3B, 0xBB, 0x75, 0xFF, 0xFF, 0xFF, 0xFF
};
#endif
#endif  /* SHARKSSL_ENABLE_PEM_API */


#if SHARKSSL_ECDSA_ONLY_VERIFY
#if SHARKSSL_ECC_USE_SECP256R1
const U8 sharkSslKey256Sig[72] =
{
   0x30, 0x46, 0x02, 0x21, 0x00, 0x31, 0x05, 0x9a, 
   0x7c, 0x75, 0x33, 0x5f, 0xd4, 0x79, 0xab, 0x89,
   0x5c, 0xdd, 0xe4, 0x0e, 0xd4, 0xc3, 0x6c, 0xb2, 
   0xa8, 0x44, 0x89, 0x27, 0xcc, 0xa4, 0x53, 0x32,
   0xb2, 0xdb, 0x5c, 0xd1, 0x44, 0x02, 0x21, 0x00, 
   0xa4, 0xbf, 0x5b, 0xca, 0x8f, 0x02, 0x8d, 0x69,
   0x7c, 0x65, 0x28, 0x6e, 0x6a, 0x93, 0xe7, 0xaa, 
   0x46, 0x9b, 0xcb, 0xcf, 0xbb, 0x72, 0xc7, 0x43,
   0x6a, 0xf4, 0x93, 0xf0, 0x1d, 0x1c, 0x85, 0xc1
};
#endif

#if SHARKSSL_ECC_USE_SECP521R1
const U8 sharkSslKey521Sig[141] =
{
   0x30, 0x81, 0x8a, 0x02, 0x43, 0x00, 0x00, 0x57, 
   0x11, 0x04, 0xf8, 0xd3, 0x5b, 0x3b, 0xac, 0xb8,
   0x43, 0x81, 0xc5, 0x3d, 0xda, 0xc5, 0x6e, 0x98, 
   0x6c, 0xae, 0xf0, 0x91, 0x07, 0x0b, 0xbe, 0xe8,
   0xf9, 0x66, 0xdb, 0x72, 0xe0, 0x6f, 0x10, 0xde, 
   0xb9, 0x3e, 0xe0, 0xbf, 0xa9, 0x52, 0xf7, 0x13,
   0x50, 0xf9, 0x71, 0x80, 0x87, 0x93, 0x54, 0x50, 
   0xdc, 0x8f, 0x6f, 0xe6, 0xc1, 0xe5, 0x9b, 0x91,
   0x95, 0x26, 0xd8, 0xfb, 0x94, 0x1c, 0x14, 0x5b, 
   0x02, 0x43, 0x00, 0x00, 0x7a, 0x1d, 0xfa, 0x2c,
   0xcf, 0xa4, 0x6a, 0x46, 0x74, 0x9d, 0xca, 0xd2, 
   0xdb, 0x0e, 0xac, 0xaf, 0xbb, 0xf4, 0x89, 0x88,
   0x4c, 0x87, 0xcf, 0x3d, 0x32, 0xd1, 0xc4, 0x2b, 
   0x4e, 0x0b, 0xb4, 0x57, 0xdc, 0x47, 0x3e, 0xcb,
   0xdd, 0xcc, 0x47, 0x18, 0x49, 0x91, 0x06, 0xe0, 
   0x6d, 0x57, 0x32, 0x2c, 0x0c, 0x53, 0x11, 0xe7,
   0xe9, 0x31, 0xca, 0xff, 0xe8, 0x13, 0x71, 0x59, 
   0x3f, 0x17, 0x9c, 0xff, 0x7c
};
#endif


static void ECDSA_verify_test(const char *pubKey, U8 *signature, U8 siglen, U8 *sha256digest)
{
   SharkSslECCKey sharkSslECCKey;
   sharkssl_ECDSA_RetVal ret;

   #if SHARKSSL_ENABLE_PEM_API
   sharkSslECCKey = sharkssl_PEM_to_ECCKey(pubKey, NULL);
   #else
   sharkSslECCKey = (SharkSslECCKey)pubKey;
   #endif

   /* verify the signature using the public key*/
   ret = sharkssl_ECDSA_verify_hash(sharkSslECCKey, signature, siglen, sha256digest, SHARKSSL_SHA256_HASH_LEN);
   if (SHARKSSL_ECDSA_OK == ret)
   {
      printf("signature succesfully verified\n");
   }
   else
   {
      printf("error in signature verification: %d\n", (int)ret);
   }

   #if SHARKSSL_ENABLE_PEM_API
   SharkSslECCKey_free(sharkSslECCKey);
   #endif
}


#else  /* SHARKSSL_ECDSA_ONLY_VERIFY */
static void ECDSA_test(const char *privKey, const char *pubKey, U8 *sha256digest)
{
   U16 sl;
   U8 signature[141];
   SharkSslECCKey sharkSslECCKey;
   sharkssl_ECDSA_RetVal ret;

   #if SHARKSSL_ENABLE_PEM_API
   sharkSslECCKey = sharkssl_PEM_to_ECCKey(privKey, NULL);
   #else
   sharkSslECCKey = (SharkSslECCKey)privKey;
   #endif
   sl = sharkssl_ECDSA_siglen(sharkSslECCKey);
   printf("sharkssl_ECDSA_siglen with private key = %d\n", sl);

   if (sl > sizeof(signature))
   {
      printf("Please increase size of signature variable to %d bytes\n", sl);
      return;
   }

   /* generate a signature of the above message digest, using the private key */
   ret = sharkssl_ECDSA_sign_hash(sharkSslECCKey, signature, &sl, sha256digest, SHARKSSL_SHA256_HASH_LEN);
   if (SHARKSSL_ECDSA_OK == ret)
   {
      printf("signature succesfully created, length = %d\n", sl);
   }
   else
   {
      printf("error in signature creation: %d\n", (int)ret);
      goto _end;
   }
   #if SHARKSSL_ENABLE_PEM_API
   SharkSslECCKey_free(sharkSslECCKey);
   #endif


   #if SHARKSSL_ENABLE_PEM_API
   sharkSslECCKey = sharkssl_PEM_to_ECCKey(pubKey, NULL);
   #else
   sharkSslECCKey = (SharkSslECCKey)pubKey;
   #endif

   /* verify the signature using the public key*/
   ret = sharkssl_ECDSA_verify_hash(sharkSslECCKey, signature, sl, sha256digest, SHARKSSL_SHA256_HASH_LEN);
   if (SHARKSSL_ECDSA_OK == ret)
   {
      printf("signature succesfully verified\n");
   }
   else
   {
      printf("error in signature verification: %d\n", (int)ret);
      goto _end;
   }

   _end:
   #if SHARKSSL_ENABLE_PEM_API
   SharkSslECCKey_free(sharkSslECCKey);
   #endif
   return;
}
#endif

void mainTask(SeCtx* ctx)
{
   SharkSslSha256Ctx sha256ctx;
   U8 sha256digest[SHARKSSL_SHA256_HASH_LEN];
   (void)ctx;
   printf("SharkSSL ECDSA demo running...\n\n");
   #if (!SHARKSSL_ECDSA_ONLY_VERIFY)
   sharkssl_entropy(0x12345678);  /* can be not available if only ECDSA verification compiled */
   #endif

   /* calculate a message digest using SHA256 */
   SharkSslSha256Ctx_constructor(&sha256ctx);
   SharkSslSha256Ctx_append(&sha256ctx, (U8*)"Hello", 5);
   SharkSslSha256Ctx_append(&sha256ctx, (U8*)"World", 5);
   SharkSslSha256Ctx_finish(&sha256ctx, sha256digest);

   #if SHARKSSL_ECC_USE_SECP256R1
   printf("test with secp256r1 EC key\n");
   #if SHARKSSL_ENABLE_PEM_API
   #if SHARKSSL_ECDSA_ONLY_VERIFY
   ECDSA_verify_test(sharkSslPubECKey256PEM, (U8*)sharkSslKey256Sig, sizeof(sharkSslKey256Sig)/sizeof(U8), (U8*)sha256digest);
   #else
   ECDSA_test(sharkSslPrivECKey256PEM, sharkSslPubECKey256PEM, (U8*)sha256digest);
   #endif

   #else  /* SHARKSSL_ENABLE_PEM_API */
   #if SHARKSSL_ECDSA_ONLY_VERIFY
   ECDSA_verify_test((const char*)sharkSslPubECKey256, (U8*)sharkSslKey256Sig, sizeof(sharkSslKey256Sig)/sizeof(U8), (U8*)sha256digest);
   #else
   ECDSA_test((const char*)sharkSslPrivECKey256, (const char*)sharkSslPubECKey256, (U8*)sha256digest);
   #endif
   #endif
   #endif  /* SHARKSSL_ECC_USE_SECP256R1 */

   #if SHARKSSL_ECC_USE_SECP521R1
   printf("test with secp521r1 EC key\n");
   #if SHARKSSL_ENABLE_PEM_API
   #if SHARKSSL_ECDSA_ONLY_VERIFY
   ECDSA_verify_test(sharkSslPubECKey521PEM, (U8*)sharkSslKey521Sig, sizeof(sharkSslKey521Sig)/sizeof(U8), (U8*)sha256digest);
   #else
   ECDSA_test(sharkSslPrivECKey521PEM, sharkSslPubECKey521PEM, (U8*)sha256digest);
   #endif

   #else  /* SHARKSSL_ENABLE_PEM_API */
   #if SHARKSSL_ECDSA_ONLY_VERIFY
   ECDSA_verify_test((const char*)sharkSslPubECKey521, (U8*)sharkSslKey521Sig, sizeof(sharkSslKey521Sig)/sizeof(U8), (U8*)sha256digest);
   #else
   ECDSA_test((const char*)sharkSslPrivECKey521, (const char*)sharkSslPubECKey521, (U8*)sha256digest);
   #endif
   #endif
   #endif  /* SHARKSSL_ECC_USE_SECP521R1 */

   printf("SharkSSL ECDSA demo complete.\n\n");
}

#if  HOST_PLATFORM == 1
int main()
{
   mainTask(0);
   return 0;
}
#endif
